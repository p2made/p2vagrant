# 05 Install Apache (with SSL 🔐 & Markdown 📄)

--

### Create `provision/scripts/install_apache.sh`

```
#!/bin/bash

# 05 Install Apache (with SSL & Markdown)

script_name="install_apache.sh"
updated_date="2024-02-15"

active_title="Installing Apache (with SSL 🔐 & Markdown 📄)"
job_complete="Apache Installed (with SSL 🔐 & Markdown 📄)"

# Source common functions
source /var/www/provision/scripts/_banners.sh
source /var/www/provision/scripts/_common.sh
source /var/www/provision/scripts/_sites.sh

# Arguments...
VM_HOSTNAME="$1"

# Script variables...
# NONE!

# Always set package_list when using update_and_install_packages
package_list=(
	"apache2"
	"apache2-bin"
	"apache2-data"
	"apache2-utils"
)

markdown_packages=(
	"markdown"
	"pandoc"
)

# -- -- /%/ -- -- /%/ -- -- /%/ -- -- /%/ -- -- /%/ -- -- /%/ -- -- /%/ -- -- #

# Function to install Apache
# Usage: install_apache
function install_apache() {
	# Add repository for ondrej/apache2
	LC_ALL=C.UTF-8 add-apt-repository -yu ppa:ondrej/apache2 ||
		handle_error "Failed to add Apache repository"

	# Update package lists & install packages
	update_package_lists
	install_packages $package_list

	# Enable required Apache modules
	a2enmod rewrite
	a2enmod ext_filter
	a2enmod ssl

	announce_success "Apache packages installed successfully!"

	install_packages $markdown_packages

	announce_success "Markdown rendering packages installed successfully!"
}

# Function to configure the default website
# Usage: configure_default_website
function configure_default_website() {
	# We have the data all as we want it, but in a global variable
	# Put it in local variables, & erase the global variable
	domain=$VM_HOSTNAME
	underscore_domain="html"
	template_filename="0.conf"
	vhosts_filename="local.conf"
	ssl_base_filename="$domain"_"$TODAYS_DATE"

	# Now go configure some web sites
	generate_vhosts_file \
		"$domain" \
		"$underscore_domain" \
		"$template_filename" \
		"$vhosts_filename" \
		"$ssl_base_filename"
	generate_ssl_files \
		"$domain" \
		"$ssl_base_filename"
	configure_website \
		"$domain" \
		"$underscore_domain" \
		"$vhosts_filename" \
		"$ssl_base_filename"

	# Disable the default site
	a2dissite 000-default
}

# -- -- /%/ -- -- /%/ -- -- /%/ -- -- /%/ -- -- /%/ -- -- /%/ -- -- /%/ -- -- #

function provision() {
	# Header banner
	header_banner "$active_title" "$script_name" "$updated_date"

	export DEBIAN_FRONTEND=noninteractive

	install_apache
	configure_default_website

	# Restart Apache to apply changes
	systemctl restart apache2

	# Footer banner
	footer_banner "$job_complete"
}

provision
```

### Create `provision/html/index.htm`

```
<html>
<head>
	<title>Shaka Bom!</title>
</head>
<body>
	<h1>Shaka Bom!</h1>
	<p>How cool is this?</p>
</body>
</html>
```

The page is a simple `index.html` located within your VM in the `/var/www/html` directory, the so-called document root. This document root is the directory that's available from the outside to your server.

### Create `provision/html/index.md`

```
# Shaka Bom!

How cool is this?

**BTW:** this is in [Markdown](https://www.markdownguide.org)
```

This is the same page (except for that extra line) in Markdown. Because of the file type ordering in `local.conf`, `index.md` will load in preference to `index.html` or `index.htm` files if it is present. You can change that by editing the `DirectoryIndex` entries in `0.conf` & `1.conf`.

### Create `provision/vhosts/local.conf`

Actually, no. This file is generated by the provisioning script, & looks like...

```
#
# html.conf
# Domain:    p2vagrant
# Generated: 2024-02-15
#

<VirtualHost *:80>
	ServerName p2vagrant
	ServerAlias www.p2vagrant
	Redirect permanent / https://p2vagrant/
</VirtualHost>

<VirtualHost *:443>
	ServerName p2vagrant
	ServerAlias www.p2vagrant
	ServerAdmin admin@example.com
	DocumentRoot /var/www/html
	DirectoryIndex index.php index.md index.htm index.html

	SSLEngine on
	SSLCertificateFile /etc/apache2/sites-available/p2vagrant_2024-02-15.cert
	SSLCertificateKeyFile /etc/apache2/sites-available/p2vagrant_2024-02-15.key

	ExtFilterDefine md-to-html mode=output \
		intype=text/markdown outtype=text/html \
		cmd="/usr/bin/markdown"

	<Directory /var/www/html>
		# Allow .htaccess rewrite rules
		Options Indexes FollowSymLinks
		AllowOverride All
		Require all granted
		SetOutputFilter md-to-html
		AddType text/markdown .md
	</Directory>

	ErrorLog "/var/www/vm_logs/html_error_log"
	CustomLog "/var/www/vm_logs/html_access_log" common
</VirtualHost>
```

‼️ Note the logs location, `/var/www/vm_logs`. That's in the project folder, so those logs can be read directly on your Mac.


### Update `Vagrantfile`

```
# -*- mode: ruby -*-
# vi: set ft=ruby

# 05 Install Apache (with SSL & Markdown)
# Generated: 2024-02-15

# Machine Variables
VM_HOSTNAME         = "p2vagrant"
VM_IP               = "192.168.22.42"
TIMEZONE            = "Australia/Brisbane"
MEMORY              = 4096
CPUS                = 1

# Synced Folders
HOST_FOLDER         = "."
VM_FOLDER           = "/var/www"

# Software Versions
SWIFT_VERSION       = "5.9.2"

Vagrant.configure("2") do |config|

	config.vm.box = "bento/ubuntu-20.04-arm64"

	config.vm.provider "vmware_desktop" do |v|
		v.memory    = MEMORY
		v.cpus      = CPUS
		v.gui       = true
	end

	# Configure network...
	config.vm.network "private_network", ip: VM_IP

	# Set a synced folder...
	config.vm.synced_folder HOST_FOLDER, VM_FOLDER, create: true, nfs: true, mount_options: ["actimeo=2"]

	# Upgrade check...
	config.vm.provision :shell, path: "provision/scripts/upgrade_vm.sh", run: "always"

	# Provisioning...
#	config.vm.provision :shell, path: "provision/scripts/install_utilities.sh", args: [VM_HOSTNAME, TIMEZONE]
#	config.vm.provision :shell, path: "provision/scripts/install_swift.sh", args: [SWIFT_VERSION]
	config.vm.provision :shell, path: "provision/scripts/install_apache.sh", args: [VM_HOSTNAME]

end
```

Or run...

```
./vg 5
```

### Provision the VM...

If the VM is **not** running

```
vagrant up --provision
```

If the VM is running

```
vagrant reload --provision
```

`index.htm` will be copied to `HOST_FOLDER/html/`.

### Import SSL certificate to System Keychain

SSL is enabled from the get-go, & Safari will make you jump through hoops to access the site. To avoid this, import the certificate at `./provision/ssl/` to you System Keychain. Strap in, you'll need to authenticate repeatedly...

1. Open `Keychain Access`.
2. Select `System`.
3. Either using `File > Import Items…` (Command-Shift-i) or by dragging the file to the `Keychain Access` window, import the certificate you've just generated.
4. Select the newly imported certificate, & get info (Command-i).
5. Toggle next to **Trust** to show the trust settings.
6. For "When using this certificate", select Always Trust.
7. Close the info window.

When setting more sites up later, do the same with the new certificates.

### Edit the `hosts` file of your Mac

Open the file `/etc/hosts` in your preferred text editor. I use [BBEdit](https://www.barebones.com/products/bbedit/), with which I can open the file from Terminal with `BBEdit /etc/hosts`, or by navigating to it in the open file dialog of BBEdit. You will need to confirm for editing the file, then authenticate as an admin user to save it.

Add this line...

```
192.168.22.42   p2vagrant
```

⚠️ **DO NOT** change anything already in your `hosts` file unless you are supremely confident of what you are doing. I use a separator line, & only edit below it...

```
# original above, additions below
```

### Visit

* [https://p2vagrant/](https://p2vagrant/)

For the same as `html` visit...

* [https://p2vagrant/index.htm](https://p2vagrant/index.htm)

You should see that minimal page in each case.

For the Apache default page of your VM visit...

* [https://p2vagrant/index.html](https://p2vagrant/index.html)

### All good?

Save the moment with a [Snapshot](./Snapshots.md).

--

<!-- 05 Install Apache (with SSL & Markdown) -->
| [04 Install Swift (optional)](./04_Install_Swift.md)
| [**Back to Steps**](../README.md)
| [06 Install PHP (with Composer)](./06_Install_PHP.md)
|

--

p2vagrant - &copy; 2024, Pedro Plowman, Australia 🇦🇺 🇺🇦 🇰🇿 🇰🇬 🇹🇯 🇹🇲 🇺🇿 🇦🇿 🇲🇳

--
