# 06 Install Apache (with SSL ðŸ™ƒ)

Updated: 2024-02-13

--

### Create `provision/scripts/install_apache.fish`

```
#!/bin/fish

# 06 Install Apache (with SSL)

set script_name     "install_apache.fish"
set updated_date    "2024-02-12"

set active_title    "Installing Apache (with SSL ðŸ™ƒ)"
set job_complete    "Apache Installed (with SSL ðŸ™ƒ)"

# Source common functions
source /var/www/provision/scripts/common_functions.fish

# Arguments...
set VM_HOSTNAME     $argv[1]
set VM_IP           $argv[2]

# Script variables...
# NONE!

# Always set PACKAGE_LIST when using update_and_install_packages
set PACKAGE_LIST \
	apache2 \
	apache2-bin \
	apache2-data \
	apache2-utils

# -- -- /%/ -- -- /%/ -- -- /%/ -- -- /%/ -- -- /%/ -- --

# Function to install Apache
# Usage: install_apache
function install_apache
	# Add repository for ondrej/apache2
	LC_ALL=C.UTF-8 apt-add-repository -yu ppa:ondrej/apache2

	# Update package lists & install packages
	update_and_install_packages $PACKAGE_LIST

	announce_success "Apache packages installed successfully!"
end

# Function to configure the default website
# Usage: configure_default_website
function configure_default_website
	# We have the data all as we want it, but in a global variable
	# Put it in local variables, & erase the global variable
	set domain            $VM_HOSTNAME
	set underscore_domain "html"
	set template_filename "0.conf"
	set vhosts_filename   "local.conf"
	set ssl_base_filename "$domain"_"$TODAYS_DATE"

	# Now go configure some web sites
	# Usage: write_vhosts_file $domain $underscore_domain $template_filename $vhosts_filename $ssl_base_filename
	write_vhosts_file \
		$domain \
		$underscore_domain \
		$template_filename \
		$vhosts_filename \
		$ssl_base_filename
	# Usage: generate_ssl_files $domain $ssl_base_filename
	generate_ssl_files \
		$domain \
		$ssl_base_filename
	configure_website \
		$domain \
		$underscore_domain \
		$vhosts_filename \
		$ssl_base_filename

	# Check if index.html exists in the html folder
	if not test -e $SHARED_HTML/index.html
		cp $PROVISION_HTML/index.html $SHARED_HTML/
	end

	# Set permissions on web server files
	chmod -R 755 $SHARED_HTML/*

	a2ensite local.conf
	a2dissite 000-default
	a2enmod rewrite
	a2enmod ssl
end

# -- -- /%/ -- -- /%/ -- -- /%/ -- -- /%/ -- -- /%/ -- --

function advance_vm
	# Header banner
	header_banner "$active_title" "$script_name" "$updated_date"

	set -x DEBIAN_FRONTEND noninteractive

	install_apache
	configure_default_website

	# Restart Apache to apply changes
	systemctl restart apache2

	# Footer banner
	footer_banner "$job_complete"
end

advance_vm
```

### Create `provision/html/index.htm`

```
<html>
<head>
	<title>Shaka Bom!</title>
</head>
<body>
	<h1>Shaka Bom!</h1>
	<p>How cool is this?</p>
</body>
</html>
```

The page is a simple `index.html` located within your VM in the `/var/www/html` directory, the so-called document root. This document root is the directory that's available from the outside to your server.

### Create `provision/vhosts/local.conf`

Actually, no. This file is generated by the provisioning script, & looks like...

```
#
# html.conf
# Domain:    p2vagrant
# Generated: 2024-02-13
#

<VirtualHost *:80>
	ServerName p2vagrant
	ServerAlias www.p2vagrant
	Redirect permanent / https://p2vagrant/
</VirtualHost>

<VirtualHost *:443>
	ServerName p2vagrant
	ServerAlias www.p2vagrant
	ServerAdmin admin@example.com
	DocumentRoot /var/www/html
	DirectoryIndex index.php index.html

	SSLEngine on
	SSLCertificateFile /etc/apache2/sites-available/p2vagrant_2024-02-13.cert
	SSLCertificateKeyFile /etc/apache2/sites-available/p2vagrant_2024-02-13.key

	<Directory /var/www/html>
		# Allow .htaccess rewrite rules
		Options Indexes FollowSymLinks
		AllowOverride All
		Require all granted
	</Directory>

	ErrorLog "/var/log/apache2/html_error_log"
	CustomLog "/var/log/apache2/html_access_log" common
</VirtualHost>
```

### Update `Vagrantfile`

```
# -*- mode: ruby -*-
# vi: set ft=ruby

# 06 Install Apache (with SSL)
# Generated: 2024-02-13

# Machine Variables
VM_HOSTNAME         = "p2vagrant"
VM_IP               = "192.168.22.42"
TIMEZONE            = "Australia/Brisbane"
MEMORY              = 4096
CPUS                = 1

# Synced Folders
HOST_FOLDER         = "."
VM_FOLDER       = "/var/www"

# Software Versions
SWIFT_VERSION       = "5.9.2"

Vagrant.configure("2") do |config|

	config.vm.box = "bento/ubuntu-20.04-arm64"

	config.vm.provider "vmware_desktop" do |v|
		v.memory    = MEMORY
		v.cpus      = CPUS
		v.gui       = true
	end

	# Configure network...
	config.vm.network "private_network", ip: VM_IP

	# Set a synced folder...
	config.vm.synced_folder HOST_FOLDER, VM_FOLDER, create: true, nfs: true, mount_options: ["actimeo=2"]

	# Upgrade check...
	config.vm.provision :shell, path: "provision/scripts/upgrade_vm.fish", args: [VM_HOSTNAME], run: "always"

	# Provisioning...
#	config.vm.provision :shell, path: "provision/scripts/upgrade_vm.sh", args: [TIMEZONE]
#	config.vm.provision :shell, path: "provision/scripts/install_utilities.sh"
#	config.vm.provision :shell, path: "provision/scripts/install_swift.fish", args: [SWIFT_VERSION]
	config.vm.provision :shell, path: "provision/scripts/install_apache.fish", args: [VM_HOSTNAME, VM_IP]

end
```

Or run...

```
./vg 6
```

### Provision the VM...

If the VM is **not** running

```
vagrant up --provision
```

If the VM is running

```
vagrant reload --provision
```

`index.htm` will be copied to `HOST_FOLDER/html/`.

### Import SSL certificate to System Keychain

SSL is enabled from the get-go, & Safari will make you jump through hoops to access the site. To avoid this, import the certificate at `./provision/ssl/` to you System Keychain. Strap in, you'll need to authenticate repeatedly...

1. Open `Keychain Access`.
2. Select `System`.
3. Either using `File > Import Itemsâ€¦` (Command-Shift-i) or by dragging the file to the `Keychain Access` window, import the certificate you've just generated.
4. Select the newly imported certificate, & get info (Command-i).
5. Toggle next to **Trust** to show the trust settings.
6. For "When using this certificate", select Always Trust.
7. Close the info window.

When setting more sites up later, do the same with the new certificates.

### Edit the `hosts` file of your Mac

Open the file `/etc/hosts` in your preferred text editor. I use [BBEdit](https://www.barebones.com/products/bbedit/), with which I can open the file from Terminal with `BBEdit /etc/hosts`, or by navigating to it in the open file dialog of BBEdit. You will need to confirm for editing the file, then authenticate as an admin user to save it.

Add this line...

```
192.168.22.42   p2vagrant
```


### Visit

* [https://p2vagrant/](https://p2vagrant/)

You should see a minimal page that I put there. For the Apache default page of your VM visit...

* [https://p2vagrant/index.html](https://p2vagrant/index.html)

### All good?

Save the moment with a [Snapshot](./Snapshots.md).

--

<!-- 06 Install Apache (with SSL) -->
| [05 Install Swift (optional)](./05_Install_Swift.md)
| [**Back to Steps**](../README.md)
| [07 Install PHP (with Composer)](./07_Install_PHP.md)
|
